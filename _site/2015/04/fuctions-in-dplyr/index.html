<!DOCTYPE html>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="author" content="Xu Kuang" />
      <title>dplyr包中的基础操作 | Xu Kuang</title>
      <link rel="shortcut icon" href="/favicon.ico">
      <link href="http://xukuang.github.io/blog/feed/" rel="alternate" title="Xu Kuang" type="application/atom+xml" />
      <link rel="stylesheet" href="/media/css/style.css"><!--博文中标签样式定义-->
      <link rel="stylesheet" href="/media/css/highlight.css">
      <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
      <!--highlight.js Start-->
      <link rel="stylesheet" title="Default" href="/media/js/styles/tomorrow-night-blue.css">
      <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
      <script>
         hljs.configure({tabReplace: '    '});
         hljs.initHighlightingOnLoad();
      </script>
      <!--highlight.js End-->
      <!--mathjax start-->
      <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      </script>
      <!--mathjax end-->
   </head>
  <!-- <script type="text/javascript">
    function setTimeSpan(){
    	var date = new Date();
    	timeSpan.innerText=date.format('yyyy-MM-dd hh:mm:ss');
    }
    
    Date.prototype.format = function(format)
		{
    var o =
    	{
    	    "M+" : this.getMonth()+1, //month
    	    "d+" : this.getDate(),    //day
    	    "h+" : this.getHours(),   //hour
    	    "m+" : this.getMinutes(), //minute
    	    "s+" : this.getSeconds(), //second
    	    "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
    	    "S" : this.getMilliseconds() //millisecond
    	}
    	if(/(y+)/.test(format))
    	format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4 - RegExp.$1.length));
    	for(var k in o)
    	if(new RegExp("("+ k +")").test(format))
    	format = format.replace(RegExp.$1,RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
    	return format;
		}
  </script>
   <body onLoad="setInterval(setTimeSpan,1000);">-->
   <body>
     <div id="container">
       <div id="main" role="main">
         <header>
           <h1>dplyr包中的基础操作</h1>
         </header>
         <nav>
           <!-- Sidebar -->
           <h5 id="logo" style="text-align:center;">
             <a href="http://xukuang.github.io/">HOME</a>
		   </h5>
           <span><a title="blog" class="" href="http://xukuang.github.io/blog/">BLOG</a></span>
           <span><a title="about" class="" href="http://xukuang.github.io/blog/about/">ABOUT</a></span>
           <span><a title="categories" class="" href="http://xukuang.github.io/blog/categories/">CATEGORIES</a></span>
           <span><a title="vitae" class="" href="http://xukuang.github.io/blog/vitae/">VITAE</a></span>
           <span><a title="tags" class="" href="http://xukuang.github.io/blog/tags/">TAGS</a></span>
           <span><a title="links" class="" href="http://xukuang.github.io/blog/links/">LINKS</a></span>
           <span><a title="subscribe by RSS" class="" href="http://xukuang.github.io/blog/feed/">SUBSCRIBE</a></span>
	       <!--<ul class="entry-right-list">
            <li class="date">获取每日の能量源</li>
            <li class="qr">
              <img src="http://xukuang.github.io/blog/images/beta.png" width="148" height="148" alt="ATP" style="margin-left: -10px;">
            </li>
           </ul>-->
         </nav>
         <article class="content">
           <section class="post">
<p>以前在网上看到的关于dplyr包基础函数的文章，放在这儿可以方便自己以后使用的时候随时查询,下文所有程序运行的结果，都使用Tab进行退格(仓皇上传，版面相当粗糙，后面抽时间详细整理一下)。</p>

<h2 id="dplyr">dplyr包的加载</h2>

<div class="highlighter-rouge"><pre class="highlight"><code># dplyr包加载
library(dplyr)
# 加载使用到其中数据的这些包
library(Lahman) # Lahman包的棒球比赛数据
library(hflights) # hflights包里的飞机航班数据
head(hflights)
		 Year Month DayofMonth DayOfWeek DepTime ArrTime UniqueCarrier FlightNum TailNum ActualElapsedTime
	5424 2011     1          1         6    1400    1500            AA       428  N576AA                60
	5425 2011     1          2         7    1401    1501            AA       428  N557AA                60
	5426 2011     1          3         1    1352    1502            AA       428  N541AA                70
	5427 2011     1          4         2    1403    1513            AA       428  N403AA                70
	5428 2011     1          5         3    1405    1507            AA       428  N492AA                62
	5429 2011     1          6         4    1359    1503            AA       428  N262AA                64
		 AirTime ArrDelay DepDelay Origin Dest Distance TaxiIn TaxiOut Cancelled CancellationCode Diverted
	5424      40      -10        0    IAH  DFW      224      7      13         0                         0
	5425      45       -9        1    IAH  DFW      224      6       9         0                         0
	5426      48       -8       -8    IAH  DFW      224      5      17         0                         0
	5427      39        3        3    IAH  DFW      224      9      22         0                         0
	5428      44       -3        5    IAH  DFW      224      9       9         0                         0
	5429      45       -7       -1    IAH  DFW      224      6      13         0                         0
class(hflights)
	[1] "data.frame"
</code></pre>
</div>
<!--more-->

<h2 id="section">数据转换</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>## 将过长过大的数据集转换为显示更友好的 tbl_df 类型
hflights_df &lt;- tbl_df(hflights)
</code></pre>
</div>

<h2 id="section-1">数据筛选</h2>

<div class="highlighter-rouge"><pre class="highlight"><code># 筛选filter,类似于base::subset()函数
filter(hflights_df, Month == 1, DayofMonth == 1)
filter(hflights, Month == 1, DayofMonth == 1)
# 用R自带函数实现:
hflights[hflights$Month == 1 &amp; hflights$DayofMonth == 1, ]
# 除了代码简洁外, 还支持对同一对象的任意个条件组合, 如:
filter(hflights_df, Month == 1 | Month == 2)
# 注意: 表示 AND 时要使用 &amp; 而避免 &amp;&amp;
</code></pre>
</div>

<h2 id="section-2">无重复内容的筛选</h2>

<div class="highlighter-rouge"><pre class="highlight"><code># distinct函数
distinct(hflights_df, Month, .keep_all = TRUE)
</code></pre>
</div>
<p>这里参数.keep_all = TRUE指保留除Month以外的其它列的内容。</p>

<h2 id="section-3">数据排列</h2>

<div class="highlighter-rouge"><pre class="highlight"><code># 排列: arrange(),按给定的列名依次对行进行排序.
arrange(hflights_df, DayofMonth, Month, Year)
# 对列名加 desc() 进行倒序
arrange(hflights_df, desc(ArrDelay))
# 这个函数和 plyr::arrange() 是一样的, 类似于 order()
# 用R自带函数实现:
hflights[order(hflights$DayofMonth, hflights$Month, hflights$Year), ]
hflights[order(desc(hflights$ArrDelay)), ]
</code></pre>
</div>

<h2 id="section-4">数据选择</h2>

<h3 id="select">select函数</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>#  选择: select()
# 用列名作参数来选择子数据集:
select(hflights_df, Year, Month, DayOfWeek)
# 还可以用 : 来连接列名, 没错, 就是把列名当作数字一样使用:
select(hflights_df, Year:DayOfWeek)
# 用 - 来排除列名:
select(hflights_df, -(Year:DayOfWeek))
</code></pre>
</div>

<h3 id="selectif">select_if()函数</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>hflights %&gt;% select_if(is.factor)
hflights %&gt;% select_if(is.numeric)
hflights %&gt;% select_if(function(col) is.numeric(col) &amp;&amp; mean(col) &gt; 3.5)
</code></pre>
</div>

<h2 id="section-5">数据变形</h2>

<div class="highlighter-rouge"><pre class="highlight"><code># 变形: mutate()
# 对已有列进行数据运算并添加为新列:
mutate(hflights_df, 
  gain = ArrDelay - DepDelay, 
  speed = Distance / AirTime * 60)
# 作用与 plyr::mutate() 相同, 与 base::transform() 相似, 优势在于可以在同一语句中对刚增加的列进行操作:
mutate(hflights_df, 
  gain = ArrDelay - DepDelay, 
  gain_per_hour = gain / (AirTime / 60)
)
# 而同样操作用R自带函数 transform() 的话就会报错:
transform(hflights, 
  gain = ArrDelay - DepDelay, 
  gain_per_hour = gain / (AirTime / 60)
)
</code></pre>
</div>

<h2 id="groupby">数据分组（group_by()函数）</h2>
<p>数据分组是指按指定列的内容进行分类统计分析，分类汇总后会影响一些函数的计算结果，具体可以参考<a href="http://xukuang.github.io/blog/2014/12/group-by-and-ungroup-function-in-R/">group和ungroup函数</a>。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>planes &lt;- group_by(hflights_df, TailNum)
delay &lt;- summarise(planes, 
  count = n(), 
  dist = mean(Distance, na.rm = TRUE), 
  delay = mean(ArrDelay, na.rm = TRUE))
delay &lt;- filter(delay, count &gt; 20, dist &lt; 2000)
</code></pre>
</div>

<p>此外，分类汇总时，一些也可用到：</p>

<ul>
  <li>n()计算个数</li>
  <li>n_distinct()计算唯一值的个数</li>
  <li>first(x), last(x) 和 nth(x, n): 返回值, 类似于基本包函数 x[1], x[length(x)], 和 x[n]</li>
</ul>

<h2 id="section-6">连接符（%&gt;%）</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>Batting %&gt;% group_by(playerID) %&gt;%
summarise(total = sum(G)) %&gt;% arrange(desc(total)) %&gt;% head(5)
</code></pre>
</div>

<h3 id="section-7">对所有列进行相同操作</h3>
<p>dpyr包中对所有列进行相同的操作最初采用的是summarise_each()和mutate_each()函数，在0.5.0版本以后的dplyr包将逐渐使用summarise_all()和mutate_all()函数，这里也主要将summarise_all()和mutate_all()函数。这里的相同操作主要包括求平均值、标准差、方差、最小值和最大值，此时被处理的数据列不需要必须是数字类型(只是此时会有警告提示)。然而，无论如何要进行求和操作时，所有数据列必须是数字类型(原因是sum函数对字符求和，直接返回错误，而求平均值、标准差、方差、最小值和最大值只是返回NA，并提示警告)。</p>

<ul>
  <li>summarise_all()函数</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code># 平均值，字符平均值返回NA
summarise_all(hflights, mean)
# 标准差，字符标准差返回NA
summarise_all(hflights, sd)
# 方差，字符方差返回NA
summarise_all(hflights, var)
# 最小值，字符最小值也是可以运算的
summarise_all(hflights, min)
# 最大值，字符最大值也是可以运算的
summarise_all(hflights, max)

# 求和
hflights.dat = hflights[,! colnames(hflights) %in% c('CancellationCode', 'UniqueCarrier', 'TailNum', 'Origin', 'Dest')]
summarise_all(hflights.dat, sum))

</code></pre>
</div>

<ul>
  <li>mutate_all()函数</li>
</ul>

<p>区别于summarise_all()函数在于mutate_all()函数产生与原数据相同行和列数的结果，这里mutate_all以及下面的mutate_at()和mutate_if()函数也不同于dplyr包的mutate()函数，mutate函数在原始数据后面产生新的结果，而mutate_系列函数则直接产生与原数据相同行和列数的结果。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>temp = mutate_all(hflights.dat,  mean))
head(hflights)
head(temp)
</code></pre>
</div>

<p>此外，summarise_all()和mutate_all()函数中使用的函数还可以使用完全形式，这时候不仅可以更改结果列的名字。mutate_all()的结果将与mutate函数一样在原始数据后面产生新的结果。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mutate_all(hflights, funs("in" = . / 2.54))
mutate_all(hflights,funs(med = median))
summarise_all(hflights,funs(med = median))
# 平均值、最小值和最大值
summarise_all(hflights, funs(mean, min, max))

</code></pre>
</div>

<h3 id="section-8">对特定列进行相同操作</h3>

<h4 id="summariseatmutateat">summarise_at()和mutate_at()函数</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>mtcars %&gt;% group_by(cyl) %&gt;% summarise_at(c("mpg", "wt"), mean)
mtcars %&gt;% group_by(cyl) %&gt;% summarise_at(vars(mpg, wt), mean)
mtcars %&gt;% group_by(cyl) %&gt;% mutate_at(c("mpg", "wt"), mean)
mtcars %&gt;% group_by(cyl) %&gt;% mutate_at(vars(mpg, wt), mean)
</code></pre>
</div>

<h4 id="summariseifmutateif">summarise_if()和mutate_if()函数</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>iris %&gt;% summarise_if(is.numeric, mean, trim = 0.25)
iris %&gt;% mutate_if(is.numeric, mean, trim = 0.25)
</code></pre>
</div>
<p>同样，summarise_at()和mutate_at() &amp;&amp; summarise_if()和mutate_if()函数函数中的函数也可以使用完全形式，其结果也包含原始数据。</p>

</section>
<section class="meta">
<span>


<span>
	<a  href="http://xukuang.github.io/blog/2015/04/life-in-shenyang/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="http://xukuang.github.io/blog/2015/05/flaunt/" class="pageNav"  >Next</a>
</span>

         

<span class="author">
  <a href="http://xukuang.github.io/blog">Xu Kuang</a>
</span>
<span class="time">
  /
  <time datetime="2015-04-21">2015-04-21</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="http://xukuang.github.io/blog/categories/#技术篇" title="技术篇">技术篇</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="http://xukuang.github.io/blog/tags/#R" title="R">R</a>&nbsp;
  
  <a href="http://xukuang.github.io/blog/tags/#dplyr" title="dplyr">dplyr</a>&nbsp;
  
</span>

</section>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<!-- 多说 Share start -->
	<div class="ds-share"
                    style="text-align: right"
                    data-thread-key="/2015/04/fuctions-in-dplyr"
                    data-title="dplyr包中的基础操作"
                    data-url="http://xukuang.github.io/blog/2015/04/fuctions-in-dplyr/"
                    data-images="http://xukuang.github.io/blog"
                    data-content="|  | ." >
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">
                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
 <!-- 多说 Share end-->
				
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2015/04/fuctions-in-dplyr" data-title="dplyr包中的基础操作 | " data-url="http://xukuang.github.io/blog/2015/04/fuctions-in-dplyr/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"yiyuzhijian"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://xukuang.github.io/blog/2015/04/life-in-shenyang/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://xukuang.github.io/blog/2015/05/flaunt/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


         </article>
       </div>
	   
	   <footer>
	   <p><small><center>© 2014-2016 Maintained by <a href="http://xukuang.github.io" title="Xu Kuang">Xu Kuang</a> ｜ Powered by <a href="https://github.com/mojombo/jekyll" target="_blank">Jekyll</a> on <a href="https://github.com/xukuang" target="_blank">GitHub</a> ｜ Themed by <a href="http://yihui.name" title="Yihui" target="_blank">Yihui</a> and <a href="http://spatial-r.com/" title="Bing Zhang" target="_blank">Bing Zhang</a> </center></small></p>
	   
       </footer>

	   </div>
       
	   <!--<script type="text/javascript">
         var _gaq = _gaq || [];
         _gaq.push(['_setAccount', '']);
         _gaq.push(['_trackPageview']);
         (function() {
           var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
           ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script> -->
	
    <!-- Baidu share-->
	<!-- <script type="text/javascript">
	window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"32"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"100"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script> -->

    <!-- Baidu Button BEGIN -->
	<!-- <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?310f86f887042ea3a15786be6e96eb30";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script> -->
	<!-- Baidu Button END --> 
	
    </body>
  </html>
                                                    