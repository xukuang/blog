<!DOCTYPE html>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="author" content="Xu Kuang" />
        <title>长宽数据之间的转化(二) | Xu Kuang</title>
        <link rel="shortcut icon" href="/favicon.ico">
          <link href="http://xukuang.github.io/blog/feed/" rel="alternate" title="Xu Kuang" type="application/atom+xml" />
            <link rel="stylesheet" href="/media/css/style.css">
              <link rel="stylesheet" href="/media/css/highlight.css">
                <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
                  <!--highlight.js Start-->
                  <link rel="stylesheet" title="Default" href="/media/js/styles/tomorrow-night-blue.css">
                    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
                      <script>
                      hljs.configure({tabReplace: '    '});
                    hljs.initHighlightingOnLoad();
                    </script>
                      <!--highlight.js End-->
                      <!--mathjax start-->
                      <script type="text/javascript"
                      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
                        </script>
                        
                        <!--mathjax end-->
                        </head>
                        <body>
                        <div id="container">
                          <div id="main" role="main">
                            <header>
                            <h1>长宽数据之间的转化(二)</h1>
                            </header>
                            <nav>
                            <!-- Sidebar -->
                            <h5 id="logo" style="text-align:center;">
                              <a href="http://xukuang.github.io/">主页</a></h5>
                                <span><a title="blog" class="" href="http://xukuang.github.io/blog/">博客</a></span>
                                  <span><a title="about" class="" href="http://xukuang.github.io/blog/about/">关于</a></span>
                                    <span><a title="categories" class="" href="http://xukuang.github.io/blog/categories/">分类</a></span>
                                      <span><a title="vitae" class="" href="http://xukuang.github.io/blog/vitae/">简历</a></span>
                                        <span><a title="tags" class="" href="http://xukuang.github.io/blog/tags/">标签</a></span>
                                          <span><a title="links" class="" href="http://xukuang.github.io/blog/links/">链接</a></span>
                                            <span><a title="subscribe by RSS" class="" href="http://xukuang.github.io/blog/feed/">订阅</a></span>
                                              </nav>
                                              <article class="content">
                                              <section class="post">
<p>前面一篇<a href="http://xukuang.github.io/2016/01/18/melt-and-dcast/">文章</a>讲了用reshape2包中的函数实现长宽数据的转化，而tidyr是reshape2的升级版，主要用于数据框。这篇文章将介绍一下如何使用tidyr包中的函数实现长宽数据的转化。
## 宽数据转化为长数据
### gather函数
<code class="highlighter-rouge">
gather(data, key, value, ..., na.rm = FALSE, convert = FALSE)
</code>
<strong>data</strong> 要转化的数据，数据格式为数据框类型或者可以转化为数据框类型	
<strong>key</strong>  指定转化后数据框的指标列的列名，用于存放原数据中不同的数据指标
<strong>value</strong>  指定转化后数据框的数据列的列名，用于存放原数据中不同的数据指标对应的值		
<strong>…</strong> 指定哪些列聚到一列中。按那些列数据作为标准转化，这个参数接不能有那些列
<strong>na.rm</strong> 确定是否去除数据中的NA，默认情况下为FALSE，不去除NA
<!--more-->
### 实例
* 将所有列排成长数据(默认情况下)
<code class="highlighter-rouge">
# 加载数据
library(reshape2)
head(airquality)
	# 	Month Day variable value
	# 1     5   1    Ozone    41
	# 2     5   2    Ozone    36
	# 3     5   3    Ozone    12
	# 4     5   4    Ozone    18
	# 5     5   5    Ozone    NA
	# 6     5   6    Ozone    28
dim(airquality)
	# [1] 612   4
library(tidyr)
dat1 = gather(airquality, time, value)
head(dat1)
    #    time value
    # 1 Ozone    41
    # 2 Ozone    36
    # 3 Ozone    12
    # 4 Ozone    18
    # 5 Ozone    NA
    # 6 Ozone    28
tail(dat1)
    #         time value
    # 913  Day    25
    # 914  Day    26
    # 915  Day    27
    # 916  Day    28
    # 917  Day    29
    # 918  Day    30
dim(dat1)	
	# [1] 918   2
</code>
* 按Month将其他指标排成长数据
<code class="highlighter-rouge">
# 方法一
dat2 = gather(airquality, time, value, Ozone:Temp, Day)
# 方法二
dat2 = gather(airquality, time, value, -Month)
head(dat2)
	#    Month Day  time value
	# 1     5   1 Ozone    41
	# 2     5   2 Ozone    36
	# 3     5   3 Ozone    12
	# 4     5   4 Ozone    18
	# 5     5   5 Ozone    NA
	# 6     5   6 Ozone    28
tail(dat2)
	#     Month Day time value
	# 607     9  25 Temp    63
	# 608     9  26 Temp    70
	# 609     9  27 Temp    77
	# 610     9  28 Temp    75
	# 611     9  29 Temp    76
	# 612     9  30 Temp    68
</code>
* 按Month和Day列将其它列指标排成长数据
<code class="highlighter-rouge">
dat3 = gather(airquality, type, value.type, Ozone:Temp)
dat3 = gather(airquality, type, value.type, -Month, -Day)
head(dat3) 
	# 	 Month Day  type value.type
	# 1     5   1 Ozone         41
	# 2     5   2 Ozone         36
	# 3     5   3 Ozone         12
	# 4     5   4 Ozone         18
	# 5     5   5 Ozone         NA
	# 6     5   6 Ozone         28
dim(dat3)
	# [1] 612   4
</code>
* 去除排列后数据中的NA
<code class="highlighter-rouge">
#　 airquality$Ozone 数的前四列有44 个NA
table(is.na(airquality$Ozone)) # 37
	# FALSE  TRUE 
	#   116    37 
table(is.na(airquality$Solar.R)) # 4
	# FALSE  TRUE 
	#   146     7 
table(is.na(airquality$Temp)) # 0
	# FALSE 
	#   153 
table(is.na(airquality$Wind)) # 0
	# FALSE 
	#   153 
dat4 = gather(airquality, type, value.type, Ozone:Temp, na.rm = TRUE)
head(dat4)
	#   Month Day  type value.type
	# 1     5   1 Ozone         41
	# 2     5   2 Ozone         36
	# 3     5   3 Ozone         12
	# 4     5   4 Ozone         18
	# 6     5   6 Ozone         28
	# 7     5   7 Ozone         23
dim(dat4)# 比dat3少44行
	# [1] 568   4	
</code></p>

<h2 id="section">长数据转化为宽数据</h2>
<p>### spread函数
<code class="highlighter-rouge">
spread(data, key, value, fill = NA, convert = FALSE, drop = TRUE)
</code>
<strong>data</strong> 要转化的数据，数据格式为数据框类型或者可以转化为数据框类型
<strong>key</strong>  指定需要将变量值拓展为字段的变量
<strong>value</strong>  指定要分散的值
<strong>fill</strong> 确认不存在的组合值的显示结果。默认的显示为NA。数据类型为数值型向量
<strong>drop</strong> 确认不存在分分类组合是否显示，默认情况下显示。当然，如果drop = T，那么fill参数的设置将失去意义
### 实例
<code class="highlighter-rouge">R
air1 =  spread(dat4, type, value.type)
dim(air1)
	# [1] 153   6
head(air1) # 数据与airquality相同
	# 	Month Day Ozone Solar.R Wind Temp
	# 1     5   1    41     190  7.4   67
	# 2     5   2    36     118  8.0   72
	# 3     5   3    12     149 12.6   74
	# 4     5   4    18     313 11.5   62
	# 5     5   5    NA      NA 14.3   56
	# 6     5   6    28      NA 14.9   66
</code>
不存在的分类是否显示，以及怎么显示
<code class="highlighter-rouge">
air5 = spread(dat4, type, value.type, drop = F) # 组合上存在的结果都显示
tail(air5) # 这里的最后一行只是组合上存在，原数据中并不在
	# 		 Month Day Ozone Solar.R Wind Temp
	# 150      9  26     1       1    1    1
	# 151      9  27     1       1    1    1
	# 152      9  28     1       1    1    1
	# 153      9  29     1       1    1    1
	# 154      9  30     1       1    1    1
	# 155      9  31     0       0    0    0
tail(spread(dat4, type, value.type, drop = F, fill= -1)) # 更改不存在结果的显示值，最后一行显示为-1
	# 		Month Day Ozone Solar.R Wind Temp
	# 150     9  26     1       1    1    1
	# 151     9  27     1       1    1    1
	# 152     9  28     1       1    1    1
	# 153     9  29     1       1    1    1
	# 154     9  30     1       1    1    1
	# 155     9  31    -1      -1   -1   -1
</code>
## tidyr包中的其它函数
### seperate函数
unite()函数可将多列合并为一列。
<code class="highlighter-rouge">
unite(data, col, ..., sep = "_", remove = TRUE)
</code>
<strong>data</strong> 要处理的数据框
<strong>col</strong> 被组合的新列名称
<strong>…</strong> 指定哪些列需要被组合
<strong>sep</strong> 组合列之间的连接符，默认为下划线
<strong>remove</strong> 是否删除被组合的列，默认删除
```
set.seed(10)
date &lt;- as.Date(‘2016-04-10’) + 0:14
hour &lt;- sample(1:24, 15)
min &lt;- sample(1:60, 15)
second &lt;- sample(1:60, 15)
event &lt;- sample(letters, 15)
data &lt;- data.frame(date, hour, min, second, event)
data
	# 			date hour min second event
	# 1  2016-04-10   13  26     33     e
	# 2  2016-04-11    8   4      6     a
	# 3  2016-04-12   10  16     10     l
	# 4  2016-04-13   15  23     52     c
	# 5  2016-04-14    2  47     24     r
	# 6  2016-04-15    5  48     42     h
	# 7  2016-04-16   19  34     45     s
	# 8  2016-04-17   18  42     51     z
	# 9  2016-04-18   22  19     36     i
	# 10 2016-04-19    7  21     26     d
	# 11 2016-04-20   16  36     14     j
	# 12 2016-04-21   23  53     12     g
	# 13 2016-04-22   20  12      1     o
	# 14 2016-04-23   21  37     35     f
	# 15 2016-04-24    4  17     49     n</p>

<p>dataNew &lt;- data %&gt;%
  unite(datehour, date, hour, sep = ‘ ‘) %&gt;%
  unite(datetime, datehour, min, second, sep = ‘:’)
	#              datetime event
	#1  2016-04-10 13:26:33     e
	#2     2016-04-11 8:4:6     a
	#3  2016-04-12 10:16:10     l
	#4  2016-04-13 15:23:52     c
	#5   2016-04-14 2:47:24     r
	#6   2016-04-15 5:48:42     h
	#7  2016-04-16 19:34:45     s
	#8  2016-04-17 18:42:51     z
	#9  2016-04-18 22:19:36     i
	#10  2016-04-19 7:21:26     d
	#11 2016-04-20 16:36:14     j
	#12 2016-04-21 23:53:12     g
	#13  2016-04-22 20:12:1     o
	#14 2016-04-23 21:37:35     f
	#15  2016-04-24 4:17:49     n</p>

<div class="highlighter-rouge"><pre class="highlight"><code>tidyr包中的函数也可使用管道操作符%&gt;%。
### seperate函数
separate()函数可将一列拆分为多列，一般可用于日志数据或日期时间型数据的拆分。
</code></pre>
</div>
<p>separate(data, col, into, sep = “[^[:alnum:]]+”, remove = TRUE,
  convert = FALSE, extra = “warn”, fill = “warn”, …)
<code class="highlighter-rouge">
**data** 要处理的数据框
**col** 需要被拆分的列
**into** 新建的列名，为字符串向量
**sep** 被拆分列的分隔符
**remove** 是否删除被分割的列，默认删除
</code>
dataold &lt;- dataNew %&gt;% 
  separate(datetime, c(‘date’, ‘time’), sep = ‘ ‘) %&gt;% 
  separate(time, c(‘hour’, ‘min’, ‘second’), sep = ‘:’)
dataold
	# 		date hour min second event
	# 1  2016-04-10   13  26     33     e
	# 2  2016-04-11    8   4      6     a
	# 3  2016-04-12   10  16     10     l
	# 4  2016-04-13   15  23     52     c
	# 5  2016-04-14    2  47     24     r
	# 6  2016-04-15    5  48     42     h
	# 7  2016-04-16   19  34     45     s
	# 8  2016-04-17   18  42     51     z
	# 9  2016-04-18   22  19     36     i
	# 10 2016-04-19    7  21     26     d
	# 11 2016-04-20   16  36     14     j
	# 12 2016-04-21   23  53     12     g
	# 13 2016-04-22   20  12      1     o
	# 14 2016-04-23   21  37     35     f
	# 15 2016-04-24    4  17     49     n
```</p>


</section>
<section class="meta">



<span>
	<a  href="http://xukuang.github.io/blog/2016/04/simple-linear-regression/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="http://xukuang.github.io/blog/2016/04/data-table-in-R/" class="pageNav"  >Next</a>
</span>


<span class="author">
  <a href="http://xukuang.github.io/cn">Xu Kuang</a>
</span>
<span class="time">
  /
  <time datetime="2016-04-10">2016-04-10</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="http://xukuang.github.io/blog/categories/#技术篇" title="技术篇">技术篇</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="http://xukuang.github.io/blog/tags/#R" title="R">R</a>&nbsp;
  
  <a href="http://xukuang.github.io/blog/tags/#tidyr" title="tidyr">tidyr</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname ='Xu_Kuang'; // required: replace example with your forum shortname
    var disqus_url = 'http://xukuang.github.io/blog/2016/04/data-fomrat/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://xukuang.github.io/blog/2016/04/simple-linear-regression/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://xukuang.github.io/blog/2016/04/data-table-in-R/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


                                              </article>
                                                </div>
                                                </div>
                                                <script type="text/javascript">
                                                  var _gaq = _gaq || [];
                                                  _gaq.push(['_setAccount', '']);
                                                  _gaq.push(['_trackPageview']);
                                                  (function() {
                                                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                                                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                                                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                                                  })();
                                                  </script>
                                                    </body>
                                                    </html>
                                                    