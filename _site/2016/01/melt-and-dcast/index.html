<!DOCTYPE html>
  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <meta name="author" content="Xu Kuang" />
      <title>长宽数据之间的转化(一) | Xu Kuang</title>
      <link rel="shortcut icon" href="/favicon.ico">
      <link href="http://xukuang.github.io/blog/feed/" rel="alternate" title="Xu Kuang" type="application/atom+xml" />
      <link rel="stylesheet" href="/media/css/style.css">
      <link rel="stylesheet" href="/media/css/highlight.css">
      <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
      <!--highlight.js Start-->
      <link rel="stylesheet" title="Default" href="/media/js/styles/tomorrow-night-blue.css">
      <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
      <script>
         hljs.configure({tabReplace: '    '});
         hljs.initHighlightingOnLoad();
      </script>
      <!--highlight.js End-->
      <!--mathjax start-->
      <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      </script>
      <!--mathjax end-->
   </head>
   <script type="text/javascript">
    function setTimeSpan(){
    	var date = new Date();
    	timeSpan.innerText=date.format('yyyy-MM-dd hh:mm:ss');
    }
    
    Date.prototype.format = function(format)
		{
    var o =
    	{
    	    "M+" : this.getMonth()+1, //month
    	    "d+" : this.getDate(),    //day
    	    "h+" : this.getHours(),   //hour
    	    "m+" : this.getMinutes(), //minute
    	    "s+" : this.getSeconds(), //second
    	    "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
    	    "S" : this.getMilliseconds() //millisecond
    	}
    	if(/(y+)/.test(format))
    	format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4 - RegExp.$1.length));
    	for(var k in o)
    	if(new RegExp("("+ k +")").test(format))
    	format = format.replace(RegExp.$1,RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
    	return format;
		}
  </script>
   <body>
     <div id="container">
       <div id="main" role="main">
         <header>
           <h1>长宽数据之间的转化(一)</h1>
         </header>
         <nav>
           <!-- Sidebar -->
           <h5 id="logo" style="text-align:center;">
             <a href="http://xukuang.github.io/">HOME</a>
		   </h5>
           <span><a title="blog" class="" href="http://xukuang.github.io/blog/">BLOG</a></span>
           <span><a title="about" class="" href="http://xukuang.github.io/blog/about/">ABOUT</a></span>
           <span><a title="categories" class="" href="http://xukuang.github.io/blog/categories/">CATEGORIES</a></span>
           <span><a title="vitae" class="" href="http://xukuang.github.io/blog/vitae/">VITAE</a></span>
           <span><a title="tags" class="" href="http://xukuang.github.io/blog/tags/">TAGS</a></span>
           <span><a title="links" class="" href="http://xukuang.github.io/blog/links/">LINKS</a></span>
           <span><a title="subscribe by RSS" class="" href="http://xukuang.github.io/blog/feed/">SUBSCRIBE</a></span>
	       <!--<ul class="entry-right-list">
            <li class="date">获取每日の能量源</li>
            <li class="qr">
              <img src="http://xukuang.github.io/blog/images/beta.png" width="148" height="148" alt="ATP" style="margin-left: -10px;">
            </li>
           </ul>-->
         </nav>
         <article class="content">
           <section class="post">
<p>这里将数据框分为两种：宽数据和长数据，宽数据便于数据成果的展示，长数据则便于数据在R中进行分析。reshape2包中的melt函数可以实现宽数据向长数据的转换，而dcast可以实现宽数据向长数据的转化。</p>

<h2 id="section">宽数据转化为长数据</h2>

<h3 id="melt">melt函数</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>melt(data, id.vars, measure.vars,
  variable.name = "variable", ..., na.rm = FALSE, value.name = "value",
  factorsAsStrings = TRUE)
</code></pre>
</div>

<p><strong>data</strong> 要转化的数据，数据格式为数据框类型或者可以转化为数据框类型</p>

<p><strong>id.vars</strong> 数据的转化标准：依照那些列进行转化，数据格式为字符型或数字型的向量。如果该参数没有限定，会把所有数据转化为两列，其中指标一列，数据一列。</p>

<p><strong>measure.vars</strong>	被转化的数据：将哪些列数据值转化，该参数在没有指定的默认情况下，会将id.vars中以外的所有列数据进行转化，数据格式为字符型或数字型的向量</p>

<p><strong>variable.name</strong>	对转化后的数据标准列重新命名，默认情况下，列名为variable</p>

<p><strong>na.rm</strong> 是否去除数据中的NA，默认情况下为FALSE，不去除NA</p>

<p><strong>value.name</strong> 对转化后的数据列重新命名，默认情况下，列名为value</p>

<p><strong>factorsAsStrings</strong>	转化过程中是否将因子类型数据转化为字符型数据，默认情况下为TRUE，将因子类型数据转化为字符型数据
<!--more--></p>

<h3 id="section-1">实例</h3>

<ul>
  <li>按Month和Day列将其他指标排成长数据</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code># 加载数据
library(reshape2)
head(airquality)
	#   Ozone Solar.R Wind Temp Month Day
	# 1    41     190  7.4   67     5   1
	# 2    36     118  8.0   72     5   2
	# 3    12     149 12.6   74     5   3
	# 4    18     313 11.5   62     5   4
	# 5    NA      NA 14.3   56     5   5
	# 6    28      NA 14.9   66     5   6
dim(airquality)	
	# [1] 153   6
dat1 = melt(airquality, id.vars = c('Month', 'Day'))
head(dat1)
	# 	Month Day variable value
	# 1     5   1    Ozone    41
	# 2     5   2    Ozone    36
	# 3     5   3    Ozone    12
	# 4     5   4    Ozone    18
	# 5     5   5    Ozone    NA
	# 6     5   6    Ozone    28
dim(dat1)
	# [1] 612   4
</code></pre>
</div>
<p>需要注意的是melt函数当中如果id.vars参数不指定值，则会把所有数据转化为两列输出。</p>

<ul>
  <li>按Month和Day列将Ozone和Solar.R列指标排成长数据</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>dat2 = melt(airquality, id.vars = c('Month', 'Day'),
 measure = c('Ozone', 'Solar.R'))
head(dat2)
	# 	Month Day variable value
	# 1     5   1    Ozone    41
	# 2     5   2    Ozone    36
	# 3     5   3    Ozone    12
	# 4     5   4    Ozone    18
	# 5     5   5    Ozone    NA
	# 6     5   6    Ozone    28
dim(dat2) # 函数是dat1的1/2
	# [1] 306   4 
</code></pre>
</div>

<ul>
  <li>对排列后的数据进行重命名</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>dat3 = melt(airquality, id.vars = c('Month', 'Day'),
variable.name = 'type', value.name = 'value.type')
head(dat3) # 列名发生变化
	# 	Month Day  type value.type
	# 1     5   1 Ozone         41
	# 2     5   2 Ozone         36
	# 3     5   3 Ozone         12
	# 4     5   4 Ozone         18
	# 5     5   5 Ozone         NA
	# 6     5   6 Ozone         28
dim(dat3)
	# [1] 612   4
</code></pre>
</div>

<ul>
  <li>去除排列后数据中的NA</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>#　 airquality$Ozone 数的前四列有44 个NA
table(is.na(airquality$Ozone)) # 37
	# FALSE  TRUE 
	#   116    37 
table(is.na(airquality$Solar.R)) # 4
	# FALSE  TRUE 
	#   146     7 
table(is.na(airquality$Temp)) # 0
	# FALSE 
	#   153 
table(is.na(airquality$Wind)) # 0
	# FALSE 
	#   153 
dat4 = melt(airquality, id.vars = c('Month', 'Day'),
variable.name = 'type', value.name = 'value.type', na.rm = TRUE)
head(dat4)
	#   Month Day  type value.type
	# 1     5   1 Ozone         41
	# 2     5   2 Ozone         36
	# 3     5   3 Ozone         12
	# 4     5   4 Ozone         18
	# 6     5   6 Ozone         28
	# 7     5   7 Ozone         23
dim(dat4)# 比dat3少44行
	# [1] 568   4	
</code></pre>
</div>
<p>此外，还发现melt函数中所有参数名都可以只写’.’前的部分。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>dat5 = melt(airquality, id = c('Month', 'Day'),
variable = 'type', value = 'value.type', na = TRUE)
head(dat5)
	# 	Month Day  type value
	# 1     5   1 Ozone    41
	# 2     5   2 Ozone    36
	# 3     5   3 Ozone    12
	# 4     5   4 Ozone    18
	# 5     5   5 Ozone    NA
	# 6     5   6 Ozone    28
</code></pre>
</div>

<h2 id="section-2">长数据转化为宽数据</h2>

<h3 id="dcast">dcast函数</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>dcast(data, formula, fun.aggregate = NULL, ..., margins = NULL,
  subset = NULL, fill = NULL, drop = TRUE,
  value.var = guess_value(data))
</code></pre>
</div>

<p><strong>data</strong> 要转化的数据，数据格式为数据框类型或者可以转化为数据框类型</p>

<p><strong>formula</strong> 转化的标准，以公式的形式定义</p>

<p><strong>fun.aggregate</strong> 汇总函数。分类后，如果分类结果不唯一，就必须使用汇总函数。常用的汇总函数，包括求个数、和、平均值、标准差、方差，默认的为求个数</p>

<p><strong>margins</strong>	确定结果是否显示总的结果，默认不显示</p>

<p><strong>subset</strong> 是否只对某些标准内容进行计算，结合plyr包一起使用</p>

<p><strong>fill</strong> 不存在的组合值的显示结果。默认的显示为0。数据类型为数值型向量</p>

<p><strong>drop</strong> 确认不存在分分类组合是否显示，默认情况下显示</p>

<p><strong>value.var</strong> 貌似对对转化后的数据进行命名，使用默认情况即可</p>

<h3 id="section-3">实例</h3>

<ul>
  <li>每个分类结果有一个数据，此时不需要使用汇总函数</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">air1</span> <span class="o">=</span>  <span class="n">dcast</span><span class="p">(</span><span class="n">dat4</span><span class="p">,</span> <span class="n">Month</span> <span class="o">+</span> <span class="n">Day</span> <span class="o">~</span> <span class="n">type</span><span class="p">)</span>
<span class="n">dim</span><span class="p">(</span><span class="n">air1</span><span class="p">)</span>
	<span class="c1"># [1] 153   6
</span><span class="n">head</span><span class="p">(</span><span class="n">air1</span><span class="p">)</span> <span class="c1"># 数据与airquality相同
</span>	<span class="c1"># 	Month Day Ozone Solar.R Wind Temp
</span>	<span class="c1"># 1     5   1    41     190  7.4   67
</span>	<span class="c1"># 2     5   2    36     118  8.0   72
</span>	<span class="c1"># 3     5   3    12     149 12.6   74
</span>	<span class="c1"># 4     5   4    18     313 11.5   62
</span>	<span class="c1"># 5     5   5    NA      NA 14.3   56
</span>	<span class="c1"># 6     5   6    28      NA 14.9   66
</span></code></pre>
</div>

<ul>
  <li>按Month列排成宽数据，每个分类结果有多个数据，必须有汇总函数</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>air2 =  dcast(dat4, Month ~ type, sum) # 这里使用sum函数
dim(air2)
	# [1] 5 5
head(air2)
	# 	Month Ozone Solar.R  Wind Temp
	# 1     5    NA      NA 360.3 2032
	# 2     6    NA    5705 308.0 2373
	# 3     7    NA    6711 277.2 2601
	# 4     8    NA      NA 272.6 2603
	# 5     9    NA    5023 305.4 2307
</code></pre>
</div>

<ul>
  <li>是否显示总的分类结果</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>air3 = dcast(dat4, Month ~ type, sum, margins = T) #列、行的总汇总都显示
dim(air3)
	# [1] 6 6
head(air3)
	#   Month Ozone Solar.R   Wind  Temp (all)
	# 1     5    NA      NA  360.3  2032    NA
	# 2     6    NA    5705  308.0  2373    NA
	# 3     7    NA    6711  277.2  2601    NA
	# 4     8    NA      NA  272.6  2603    NA
	# 5     9    NA    5023  305.4  2307    NA
	# 6 (all)    NA      NA 1523.5 11916    NA
dcast(dat4, Month ~ type, sum, margins = c('Month'))# 只显示列的汇总
	# 	Month Ozone Solar.R   Wind  Temp
	# 1     5    NA      NA  360.3  2032
	# 2     6    NA    5705  308.0  2373
	# 3     7    NA    6711  277.2  2601
	# 4     8    NA      NA  272.6  2603
	# 5     9    NA    5023  305.4  2307
	# 6 (all)    NA      NA 1523.5 11916
dcast(dat4, Month ~ type, sum, margins = c('type'))# 只显示行的汇总
	# 	Month Ozone Solar.R  Wind Temp (all)
	# 1     5    NA      NA 360.3 2032    NA
	# 2     6    NA    5705 308.0 2373    NA
	# 3     7    NA    6711 277.2 2601    NA
	# 4     8    NA      NA 272.6 2603    NA
	# 5     9    NA    5023 305.4 2307    NA
</code></pre>
</div>

<ul>
  <li>只显示部分的分类内容</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>library(plyr)
air4 = dcast(dat4, Month ~ type, sum, subset = .(type == 'Wind' )) # 只显示type中Wind的情况
dim(air4)
	# [1] 5 2
head(air4)
	# 	Month  Wind
	# 1     5 360.3
	# 2     6 308.0
	# 3     7 277.2
	# 4     8 272.6
	# 5     9 305.4
</code></pre>
</div>

<ul>
  <li>不存在的分类是否显示，以及怎么显示</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>air5 = dcast(dat4, Month + Day ~ type, length, drop = F) # 组合上存在的结果都显示
tail(air5) # 这里的最后一行只是组合上存在，数据中并不在
	# 		 Month Day Ozone Solar.R Wind Temp
	# 150      9  26     1       1    1    1
	# 151      9  27     1       1    1    1
	# 152      9  28     1       1    1    1
	# 153      9  29     1       1    1    1
	# 154      9  30     1       1    1    1
	# 155      9  31     0       0    0    0
tail(dcast(dat4, Month + Day ~ type, length, drop = F, fill= -1)) # 更改不存在结果的显示值，最后一行显示为-1
	# 		Month Day Ozone Solar.R Wind Temp
	# 150     9  26     1       1    1    1
	# 151     9  27     1       1    1    1
	# 152     9  28     1       1    1    1
	# 153     9  29     1       1    1    1
	# 154     9  30     1       1    1    1
	# 155     9  31    -1      -1   -1   -1
</code></pre>
</div>


</section>
<section class="meta">



<span>
	<a  href="http://xukuang.github.io/blog/2016/01/join-function/" class="pageNav"  >Previous</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="http://xukuang.github.io/blog/2016/02/char-in-R/" class="pageNav"  >Next</a>
</span>


<span class="author">
  <a href="http://xukuang.github.io/blog">Xu Kuang</a>
</span>
<span class="time">
  /
  <time datetime="2016-01-18">2016-01-18</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="http://xukuang.github.io/blog/categories/#技术篇" title="技术篇">技术篇</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="http://xukuang.github.io/blog/tags/#R" title="R">R</a>&nbsp;
  
  <a href="http://xukuang.github.io/blog/tags/#reshape2" title="reshape2">reshape2</a>&nbsp;
  
</span>

</section>
<div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//httpxukuanggithubio.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    if (e.target.nodeName.toUpperCase() != 'BODY') return;
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://xukuang.github.io/blog/2016/01/join-function/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://xukuang.github.io/blog/2016/02/char-in-R/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


         </article>
       </div>
	   
	   
	   <footer>
           <p><small>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> & <a href="http://pages.github.com">GitHub</a>| Copyright  2016 by <a href="http://xukuang.github.io/blog/about/">Xu Kuang</a> | <span class="label label-info" id="timeSpan"></span></small></p>
       </footer>
	   
	   
	   </div>
       
	   <script type="text/javascript">
         var _gaq = _gaq || [];
         _gaq.push(['_setAccount', '']);
         _gaq.push(['_trackPageview']);
         (function() {
           var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
           ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
		
		<!-- Baidu share -->
	<script type="text/javascript">
	window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"32"},"slide":{"type":"slide","bdImg":"0","bdPos":"right","bdTop":"100"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>

    <!-- Baidu Button BEGIN -->
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?310f86f887042ea3a15786be6e96eb30";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
	<!-- Baidu Button END -->
	
    </body>
  </html>
                                                    